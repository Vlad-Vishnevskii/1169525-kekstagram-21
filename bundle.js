(()=>{"use strict";window.constants={ESCAPE:"Escape"},window.util={getRandomInt:function(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e},debounce:function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}}},(()=>{const e=document.querySelector("main"),t=document.querySelector("body"),n=document.querySelector("#success").content.querySelector(".success"),o=document.querySelector("#error").content.querySelector(".error"),c=function(){let e;const n=document.querySelector(".success"),o=document.querySelector(".error");e=n||o,e.remove(),t.classList.remove("modal-open"),document.removeEventListener("keydown",i),e.removeEventListener("click",r)},r=function(e){const t=e.target;(t.classList.contains("success")||t.classList.contains("success__button")||t.classList.contains("error")||t.classList.contains("error__button"))&&c()},i=function(e){e.key===window.constants.ESCAPE&&(e.preventDefault(),c())};window.popup={success:function(){const t=n.cloneNode(!0);e.appendChild(t),t.addEventListener("click",r),document.addEventListener("keydown",i)},error:function(t){const n=o.cloneNode(!0),c=n.querySelector(".error__title");e.appendChild(n),c.textContent=t,n.addEventListener("click",r),document.addEventListener("keydown",i)}}})(),(()=>{const e="https://21.javascript.pages.academy/kekstagram",t={400:"Неверный запрос",401:"Пользователь не авторизирован",403:"Доступ запрещен",404:"Ничего не найдено",500:"Внутренняя ошибка сервера"},n=function(e,n){const o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(function(){200===o.status?e(o.response):n("Статус ответа: "+t[o.status])})),o.addEventListener("error",(function(){n("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){n(`Запрос не успел выполниться за ${o.timeout} мс`)})),o.timeout=1e4,o};window.backend={download:function(t,o){const c=n(t,o);c.open("GET",e+"/data"),c.send()},upload:function(t,o,c){const r=n(o,c);r.open("POST",e),r.send(t)}}})(),(()=>{const e=document.querySelector(".pictures"),t=e.querySelector(".pictures__title"),n=document.querySelector("#picture").content.querySelector(".picture"),o=function(e){const t=n.cloneNode(!0);return t.dataset.id=e.id,t.querySelector(".picture__img").src=e.url,t.querySelector(".picture__img").alt=e.description,t.querySelector(".picture__likes").textContent=e.likes,t.querySelector(".picture__comments").textContent=e.comments.length,t};window.picture={render:function(n){const c=document.createDocumentFragment();for(let e=0;e<n.length;e++)c.appendChild(o(n[e]));e.appendChild(c),t.classList.remove("visually-hidden")},remove:function(){document.querySelectorAll(".picture").forEach((function(e){e.remove()}))}}})(),window.filter=function(e,t){const n=e.slice();switch(function(e){document.querySelector(".img-filters__button--active").classList.remove("img-filters__button--active"),e.classList.contains("img-filters__button--active")||e.classList.add("img-filters__button--active")}(t),t.id){case"filter-default":return n;case"filter-random":return function(e){return e.sort((function(){return window.util.getRandomInt(-1,1)})).slice(0,10)}(n);case"filter-discussed":return function(e){return e.sort((function(e,t){return t.comments.length-e.comments.length}))}(n)}return n},(()=>{let e=[];const t=document.querySelector(".img-filters"),n=document.querySelector(".pictures");t.classList.remove("img-filters--inactive"),window.backend.download((function(t){e=t,function(e){e.forEach((function(e,t){e.id=t}))}(e),window.picture.render(e)}),(function(e){window.popup.error(e)})),t.addEventListener("click",window.util.debounce((function(t){const n=t.target.closest(".img-filters__button");n&&(window.picture.remove(),window.picture.render(window.filter(e,n)))}))),n.addEventListener("click",(function(t){let n=t.target.closest(".picture");n&&window.bigPicture.show(e[n.dataset.id])}))})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".social__comment-count"),n=document.querySelector("body"),o=e.querySelector(".big-picture__cancel"),c=e.querySelector("img"),r=e.querySelector(".likes-count"),i=e.querySelector(".social__caption"),s=e.querySelector(".social__comments"),u=e.querySelector(".social__comment"),l=e.querySelector(".comments-loader"),d=e.querySelector(".comments-shown"),a=e.querySelector(".comments-count");let m,f=1;const p=function(e){const t=document.createDocumentFragment();s.innerHTML="",e.forEach((function(e){const n=u.cloneNode(!0);n.querySelector(".social__picture").src=e.avatar,n.querySelector(".social__picture").alt=e.name,n.querySelector(".social__text").textContent=e.message,t.appendChild(n)})),s.appendChild(t)},v=function(){h()},y=function(e){e.key===window.constants.ESCAPE&&(e.preventDefault(),h())},w=function(){f++;const e=m.comments.slice(0,5*f);p(e),e.length>=m.comments.length&&l.classList.add("hidden"),d.textContent=e.length},h=function(){e.classList.add("hidden"),o.removeEventListener("click",v),document.removeEventListener("keydown",y),n.classList.remove("modal-open"),l.removeEventListener("click",w)};window.bigPicture={show:function(s){m=s,f=1,l.classList.add("hidden"),t.classList.add("hidden"),n.classList.add("modal-open"),e.classList.remove("hidden"),function(e){c.src=e.url,r.textContent=e.likes,i.textContent=e.description,p(e.comments.slice(0,5)),function(e){e.comments.length>5&&(l.classList.remove("hidden"),t.classList.remove("hidden"),d.textContent=5,a.textContent=e.comments.length)}(e)}(s),o.addEventListener("click",v),document.addEventListener("keydown",y),l.addEventListener("click",w)}}})(),(()=>{const e=["gif","jpg","jpeg","png"];window.uploadPicture=function(t,n){const o=t.files[0],c=o.name.toLowerCase();if(e.some((function(e){return c.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){n.src=e.result})),e.readAsDataURL(o)}}})(),(()=>{const e=document.querySelector(".img-upload__form"),t=document.querySelector("#upload-file"),n=document.querySelector(".img-upload__overlay"),o=document.querySelector("body"),c=n.querySelector("#upload-cancel"),r=document.querySelector(".text__description"),i=document.querySelector(".img-upload__preview").querySelector("img"),s=document.querySelector(".effect-level"),u=function(e){e.key===window.constants.ESCAPE&&r!==document.activeElement&&(e.preventDefault(),d())},l=function(){d()},d=function(){n.classList.add("hidden"),n.value="",i.src="",o.classList.remove("modal-open"),window.effects.reset(),document.removeEventListener("keydown",u),c.removeEventListener("click",l)},a=function(){n.classList.add("hidden"),window.popup.success()},m=function(e){n.classList.add("hidden"),window.popup.error(e)};t.addEventListener("change",(function(){window.uploadPicture(t,i),o.classList.add("modal-open"),s.classList.add("hidden"),n.classList.remove("hidden"),document.addEventListener("keydown",u),c.addEventListener("click",l)})),e.addEventListener("submit",(function(t){window.backend.upload(new FormData(e),a,m),t.preventDefault(),window.effects.reset(),e.reset()}))})(),window.slider={init:function(e,t,n,o){t.addEventListener("mousedown",(function(c){c.preventDefault();let r=c.clientX;const i=function(c){c.preventDefault();const i=r-c.clientX;r=c.clientX;const s=(t.offsetLeft-i)/e.clientWidth*100;s<=100&&s>=0&&(t.style.left=s+"%",n.style.width=s+"%"),o(Math.round(s))},s=function(e){e.preventDefault(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",s)}))}},(()=>{const e=100,t={chrome:1,sepia:1,marvin:100,phobos:3,heat:3},n=100,o=document.querySelector(".img-upload__preview"),c=document.querySelector(".effects"),r=document.querySelector(".img-upload__effect-level"),i=r.querySelector(".effect-level__depth"),s=r.querySelector(".effect-level__pin"),u=r.querySelector(".effect-level__value"),l=r.querySelector(".effect-level__line");let d=null;const a=document.querySelector(".scale"),m=document.querySelector(".scale__control--value");let f=n;m.value="100%",a.addEventListener("click",(function(e){e.target.closest(".scale__control--smaller")&&f>25&&f<=n&&(f-=25,m.value=f+"%",o.style.transform=`scale(${f/100})`),e.target.closest(".scale__control--bigger")&&f>=25&&f<n&&(f+=25,m.value=f+"%",o.style.transform=`scale(${f/100})`)}));const p={chrome:function(e){return`grayscale(${e.toFixed(1)})`},sepia:function(e){return`sepia(${e.toFixed(1)})`},marvin:function(e){return`invert(${e.toFixed(1)}%)`},phobos:function(e){return`blur(${e.toFixed(1)}px)`},heat:function(e){return`brightness(${e.toFixed(1)})`}};window.slider.init(l,s,i,(function(e){const n=t[d]*e/100;o.style.filter=p[d](n),u.value=e}));const v=function(){r.classList.add("hidden"),o.style.filter="",u.value=e,o.style.transform="scale(1)",m.value="100%"};c.addEventListener("change",(function(n){const c=n.target;v(),"none"===c.value?(u.value=0,r.classList.add("hidden")):(d=c.value,r.classList.remove("hidden"),s.style.left="100%",i.style.width="100%",u.value=e,o.style.filter=p[d](t[d]))})),window.effects={reset:v}})(),(()=>{const e=document.querySelector(".text__hashtags"),t=document.querySelector("#upload-select-image"),n=function(e,t,n){return n.indexOf(e,t+1)>=0};e.addEventListener("input",(function(){let o=e.value.trim().toLowerCase().split(" ");const c=/^#[\w\a-я]*$/,r=[];o=o.filter((function(e){return""!==e}));for(let e of o)"#"!==e[0]?r.push("Первый символ хеш-тега должен быть #"):e.length<=1?r.push("хеш-тег должен быть длинее одного символа"):c.test(e)?e.length>20&&r.push("хеш-тег не может может быть длинее 20 символов"):r.push("Хэштег начинается с # не может содержать спецсимволы");o.some(n)&&r.push("Один и тот же хэш-тег не может быть использован дважды"),o.length>5&&r.push("Нельзя указать больше пяти хэш-тегов"),r.length?(e.setCustomValidity(r[0]),e.classList.add("error-frame")):(e.setCustomValidity(""),e.classList.remove("error-frame")),t.reportValidity()}))})()})();